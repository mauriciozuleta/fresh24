<script>
// Format numeric fields on blur - plain numbers, max 2 decimals
function formatNumberInput(input) {
  let val = input.value.replace(/,/g, '');
  if (val && !isNaN(val)) {
    let num = parseFloat(val);
    // Round to 2 decimals
    let rounded = Math.round(num * 100) / 100;
    input.value = rounded.toString();
  }
}
function parseNumber(val) {
  if (!val) return 0;
  return parseFloat(val.replace(/,/g, '')) || 0;
}

// Conversion helpers
function kgToLbs(kg) { return kg * 2.20462; }
function lbsToKg(lbs) { return lbs / 2.20462; }
function galToLbs(gal) { return gal * 6.7; } // Approximate for Jet-A
function lbsToGal(lbs) { return lbs / 6.7; }

// Format number for input value - plain numbers, max 2 decimals
function formatNumber(num) {
  if (!num && num !== 0) return '';
  // Round to 2 decimals
  let rounded = Math.round(num * 100) / 100;
  return rounded.toString();
}

function persistAircraftForm() {
  const form = document.getElementById('aircraft-form');
  if (!form) return;
  const data = {};
  Array.from(form.elements).forEach(function(el) {
    if (el.name && (el.type === 'text' || el.type === 'number')) {
      data[el.name] = el.value;
    }
  });
  localStorage.setItem('add_aircraft_form', JSON.stringify(data));
}
function restoreAircraftForm() {
  const form = document.getElementById('aircraft-form');
  if (!form) return;
  const data = JSON.parse(localStorage.getItem('add_aircraft_form') || '{}');
  Array.from(form.elements).forEach(function(el) {
    if (el.name && data[el.name] !== undefined) {
      el.value = data[el.name];
    }
  });
}


(function() {
  // Track last edited field for each kg/lbs and gal/lbs pair
  const pairs = [
    // [kg, lbs, type]
    ['id_mtow_kg', 'id_mtow_lbs', 'weight'],
    ['id_mldgw_kg', 'id_mldgw_lbs', 'weight'],
    ['id_max_ramp_kg', 'id_max_ramp_lbs', 'weight'],
    ['id_empty_weight_kg', 'id_empty_weight_lbs', 'weight'],
    ['id_max_payload_kg', 'id_max_payload_lbs', 'weight'],
    ['id_zero_fuel_kg', 'id_zero_fuel_lbs', 'weight'],
    ['id_fuel_capacity_gal', 'id_fuel_capacity_lbs', 'volume'],
    ['id_fuel_burn_gal', 'id_fuel_burn_lbs', 'volume'],
    ['id_min_fuel_landed_gal', 'id_min_fuel_landed_lbs', 'volume'],
    ['id_min_fuel_alternate_gal', 'id_min_fuel_alternate_lbs', 'volume']
  ];
  // Restore form data if present, but only fill the last edited field and trigger conversion
  const lastEdited = JSON.parse(localStorage.getItem('add_aircraft_last_edited') || '{}');
  const formData = JSON.parse(localStorage.getItem('add_aircraft_form') || '{}');
  pairs.forEach(function([firstId, secondId, type]) {
    const firstInput = document.getElementById(firstId);
    const secondInput = document.getElementById(secondId);
    if (!firstInput || !secondInput) {
      if (firstId.includes('mldgw') || secondId.includes('mldgw')) {
        console.warn('MLDGW field not found:', firstId, secondId);
      }
      return;
    }
    // Restore only the last edited field
    if (lastEdited[firstId] && formData[firstId]) {
      firstInput.value = formData[firstId];
      firstInput.dispatchEvent(new Event('blur'));
    } else if (lastEdited[secondId] && formData[secondId]) {
      secondInput.value = formData[secondId];
      secondInput.dispatchEvent(new Event('blur'));
    }
    // Conversion logic
    firstInput.addEventListener('blur', function() {
      let val = parseNumber(firstInput.value);
      if (val) {
        let converted;
        if (type === 'weight') {
          converted = kgToLbs(val);
        } else if (type === 'volume') {
          converted = galToLbs(val);
        }
        secondInput.value = formatNumber(converted);
        firstInput.value = formatNumber(val);
      } else {
        secondInput.value = '';
      }
      // Mark first as last edited
      let le = JSON.parse(localStorage.getItem('add_aircraft_last_edited') || '{}');
      le[firstId] = true; le[secondId] = false;
      localStorage.setItem('add_aircraft_last_edited', JSON.stringify(le));
      persistAircraftForm();
    });
    secondInput.addEventListener('blur', function() {
      let val = parseNumber(secondInput.value);
      if (val) {
        let converted;
        if (type === 'weight') {
          converted = lbsToKg(val);
        } else if (type === 'volume') {
          converted = lbsToGal(val);
        }
        firstInput.value = formatNumber(converted);
        secondInput.value = formatNumber(val);
      } else {
        firstInput.value = '';
      }
      // Mark second as last edited
      let le = JSON.parse(localStorage.getItem('add_aircraft_last_edited') || '{}');
      le[firstId] = false; le[secondId] = true;
      localStorage.setItem('add_aircraft_last_edited', JSON.stringify(le));
      persistAircraftForm();
    });
    firstInput.addEventListener('input', function() {
      let le = JSON.parse(localStorage.getItem('add_aircraft_last_edited') || '{}');
      le[firstId] = true; le[secondId] = false;
      localStorage.setItem('add_aircraft_last_edited', JSON.stringify(le));
      persistAircraftForm();
    });
    secondInput.addEventListener('input', function() {
      let le = JSON.parse(localStorage.getItem('add_aircraft_last_edited') || '{}');
      le[firstId] = false; le[secondId] = true;
      localStorage.setItem('add_aircraft_last_edited', JSON.stringify(le));
      persistAircraftForm();
    });
  });

  // Format all numeric fields on blur and persist (exclude conversion pairs)
  const numericFields = [
    'id_cruise_speed', 'id_acmi_cost',
    'id_cargo_positions_main_deck', 'id_cargo_positions_lower_deck'
  ];
  numericFields.forEach(function(id) {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('blur', function() { formatNumberInput(el); persistAircraftForm(); });
      el.addEventListener('input', persistAircraftForm);
    }
  });

  // Persist all text fields
  const form = document.getElementById('aircraft-form');
  if (form) {
    Array.from(form.elements).forEach(function(el) {
      if (el.type === 'text' && !numericFields.includes(el.id)) {
        el.addEventListener('input', persistAircraftForm);
        el.addEventListener('blur', persistAircraftForm);
      }
    });
    form.addEventListener('submit', function() {
      localStorage.removeItem('add_aircraft_form');
    });

    // --- Auto-calculate Max Range at Max Payload ---
    function val(id) {
      const el = document.getElementById(id);
      return el ? parseFloat(el.value.replace(/,/g, '')) || 0 : 0;
    }
    function calcMaxRangeAtMaxPayload() {
      const mtow = val('id_mtow_lbs');
      const zfw = val('id_zero_fuel_lbs');
      const minLanded = val('id_min_fuel_landed_lbs');
      const minAlt = val('id_min_fuel_alternate_lbs');
      const fuelBurn = val('id_fuel_burn_lbs');
      const cruise = val('id_cruise_speed');
      if (fuelBurn > 0 && cruise > 0) {
        const numer = mtow - zfw - minAlt - minLanded;
        const hours = numer / fuelBurn;
        const range = hours * cruise;
        const out = document.getElementById('id_max_range_at_max_payload');
        if (out) out.value = isFinite(range) && range > 0 ? Math.round(range) : '';
      }
    }
    function calcMaxRangeWithMaxFuel() {
      const fuelCap = val('id_fuel_capacity_lbs');
      const minLanded = val('id_min_fuel_landed_lbs');
      const minAlt = val('id_min_fuel_alternate_lbs');
      const fuelBurn = val('id_fuel_burn_lbs');
      const cruise = val('id_cruise_speed');
      if (fuelBurn > 0 && cruise > 0) {
        const usableFuel = fuelCap - minLanded - minAlt;
        const hours = usableFuel / fuelBurn;
        const range = hours * cruise;
        const out = document.getElementById('id_max_range_with_max_fuel');
        if (out) out.value = isFinite(range) && range > 0 ? Math.round(range) : '';
      }
    }
    [
      'id_mtow_lbs','id_empty_weight_lbs','id_max_payload_lbs','id_min_fuel_landed_lbs','id_min_fuel_alternate_lbs','id_fuel_burn_lbs','id_cruise_speed'
    ].forEach(function(id) {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', calcMaxRangeAtMaxPayload);
        el.addEventListener('blur', calcMaxRangeAtMaxPayload);
      }
    });
    [
      'id_fuel_capacity_lbs',
      'id_fuel_burn_lbs',
      'id_cruise_speed',
      'id_min_fuel_landed_lbs',
      'id_min_fuel_alternate_lbs'
    ].forEach(function(id) {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', calcMaxRangeWithMaxFuel);
        el.addEventListener('blur', calcMaxRangeWithMaxFuel);
      }
    });
  }
})();
</script>
{% load crispy_forms_tags %}
{% if form %}
<div class="tab-content-inner aircraft-form-page">
  <div class="aircraft-header">
    <h1 class="aircraft-title">Add New Aircraft</h1>
  </div>
  <div class="conversion-note">
    <div class="conversion-note-title">Auto-Conversion</div>
    <p>Enter values in either unit (kg/lbs or gal/lbs); the corresponding field will be calculated automatically.</p>
  </div>
  <div class="aircraft-form-container">
    <form method="post" action="{% if edit_mode %}/edit-aircraft/{{ aircraft_id }}/{% else %}/add-aircraft/{% endif %}" id="aircraft-form">
      {% csrf_token %}
      <!-- Render Django form fields with custom layout -->
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Basic Information</div>
        <div class="aircraft-form-row three-col">
          {{ form.manufacturer|as_crispy_field }}
          {{ form.model|as_crispy_field }}
          {{ form.short_name|as_crispy_field }}
        </div>
      </div>
      <hr class="aircraft-section-separator" />
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Weight & Fuel Information</div>
        <div class="aircraft-form-row three-col">
          {{ form.mtow_kg|as_crispy_field }}
          {{ form.mtow_lbs|as_crispy_field }}
          {{ form.mldgw_kg|as_crispy_field }}
          {{ form.mldgw_lbs|as_crispy_field }}
          {{ form.max_ramp_kg|as_crispy_field }}
          {{ form.max_ramp_lbs|as_crispy_field }}
          {{ form.empty_weight_kg|as_crispy_field }}
          {{ form.empty_weight_lbs|as_crispy_field }}
          {{ form.max_payload_kg|as_crispy_field }}
          {{ form.max_payload_lbs|as_crispy_field }}
          {{ form.zero_fuel_kg|as_crispy_field }}
          {{ form.zero_fuel_lbs|as_crispy_field }}
          {{ form.fuel_capacity_gal|as_crispy_field }}
          {{ form.fuel_capacity_lbs|as_crispy_field }}
          {{ form.fuel_burn_gal|as_crispy_field }}
          {{ form.fuel_burn_lbs|as_crispy_field }}
          {{ form.min_fuel_landed_gal|as_crispy_field }}
          {{ form.min_fuel_landed_lbs|as_crispy_field }}
          {{ form.min_fuel_alternate_gal|as_crispy_field }}
          {{ form.min_fuel_alternate_lbs|as_crispy_field }}
        </div>
      </div>
      <hr class="aircraft-section-separator" />
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Operations &amp; Cost Information</div>
        <div class="aircraft-form-row three-col">
          {{ form.cargo_positions_main_deck|as_crispy_field }}
          {{ form.cargo_positions_lower_deck|as_crispy_field }}
          {{ form.cruise_speed|as_crispy_field }}
          {{ form.max_range_at_max_payload|as_crispy_field }}
          {{ form.max_range_with_max_fuel|as_crispy_field }}
        </div>
      </div>
      <button type="submit" class="aircraft-btn">{% if edit_mode %}Save Changes{% else %}Add Aircraft{% endif %}</button>
    </form>
  </div>
</div>
{% endif %}

<script>
// AJAX submit with progress modal for aircraft form
(function() {
  const form = document.getElementById('aircraft-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      // Disable button to prevent double-clicks
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;
      // Show progress modal
      if (window.showProgressModal) {
        window.showProgressModal('Aircraft saved successfully!', 'Please wait while the system updates routes...');
      }
      localStorage.removeItem('add_aircraft_form');
      localStorage.removeItem('add_aircraft_last_edited');
      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      })
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (window.hideProgressModal) window.hideProgressModal();
        if (submitBtn) submitBtn.disabled = false;
        if (data.success) {
          // Refresh aircraft list if function exists
          if (window.refreshAircraftList) {
            window.refreshAircraftList();
          }
          // Close the tab using VS Code tab logic
          if (window.closeCurrentTab) {
            window.closeCurrentTab();
          } else {
            // Fallback: reload page
            window.location.reload();
          }
        } else {
          alert('Error saving aircraft: ' + (data.errors ? JSON.stringify(data.errors) : 'Unknown error'));
        }
      })
      .catch(function() {
        if (window.hideProgressModal) window.hideProgressModal();
        if (submitBtn) submitBtn.disabled = false;
        alert('Error saving aircraft.');
      });
    });
  }
})();
</script>