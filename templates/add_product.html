{% if form %}
<div class="tab-content-inner aircraft-form-page">
  <div class="aircraft-header">
    <h1 class="aircraft-title">
      {% if edit_mode %}
        Edit Product
      {% else %}
        Add New Product
      {% endif %}
    </h1>
  </div>
  <div class="aircraft-form-container">
    <form method="post" action="{% if edit_mode %}/edit-product/{{ product_id }}/{% else %}/add-product/{% endif %}" id="product-form">
      {% csrf_token %}
      
      <!-- Basic Information Section -->
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Basic Information</div>
        <div class="aircraft-form-row five-col">
          <div class="aircraft-form-group">
            <label for="id_product_type">Type of Product</label>
            <select class="aircraft-form-control" name="product_type" id="id_product_type" required>
              <option value="Produce" {% if edit_mode and product.product_type == "Produce" %}selected{% endif %}>Produce</option>
              <option value="Meats" {% if edit_mode and product.product_type == "Meats" %}selected{% endif %}>Meats</option>
              <option value="Other Perishable" {% if edit_mode and product.product_type == "Other Perishable" %}selected{% endif %}>Other Perishable</option>
              <option value="Dry Goods" {% if edit_mode and product.product_type == "Dry Goods" %}selected{% endif %}>Dry Goods</option>
              <option value="Technology" {% if edit_mode and product.product_type == "Technology" %}selected{% endif %}>Technology</option>
              <option value="Other" {% if edit_mode and product.product_type == "Other" %}selected{% endif %}>Other</option>
            </select>
          </div>
          <div class="aircraft-form-group">
            <label for="id_product_code">Product Code</label>
            <input type="text" class="aircraft-form-control" name="product_code" id="id_product_code" readonly value="{% if edit_mode %}{{ product.product_code }}{% endif %}">
          </div>
          <div class="aircraft-form-group">
            <label for="id_name">Product Name</label>
            <input type="text" class="aircraft-form-control" name="name" id="id_name" required placeholder="Enter product name" value="{% if edit_mode %}{{ product.name }}{% endif %}">
          </div>
          <div class="aircraft-form-group">
            <label for="id_country">Country</label>
            <select class="aircraft-form-control" name="country_id" id="id_country" required>
              <option value="">Select Country</option>
              {% for country in countries %}
              <option value="{{ country.id }}" data-currency="{{ country.currency_code }}" {% if edit_mode and product.country.id == country.id %}selected{% endif %}>{{ country.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="aircraft-form-group">
            <label for="id_trade_unit">Trade Unit</label>
            <select class="aircraft-form-control" name="trade_unit" id="id_trade_unit" required>
              <option value="UN" {% if edit_mode and product.trade_unit == "UN" %}selected{% endif %}>Unit (Un)</option>
              <option value="BU" {% if edit_mode and product.trade_unit == "BU" %}selected{% endif %}>Bunch (BU)</option>
              <option value="KG" {% if edit_mode and product.trade_unit == "KG" %}selected{% endif %}>Kilogram (Kg.)</option>
              <option value="LBS" {% if edit_mode and product.trade_unit == "LBS" %}selected{% endif %}>Pound (Lbs.)</option>
            </select>
          </div>
        </div>
      </div>
      
      <hr class="aircraft-section-separator" />
      
      <!-- Cost Information Section -->
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Cost Information</div>
        <div class="aircraft-form-row three-col">
          <div class="aircraft-form-group">
            <label for="id_fca_cost">FCA Cost per WU</label>
            <input type="number" step="0.01" class="aircraft-form-control" name="fca_cost_per_wu" id="id_fca_cost" required placeholder="0.00" value="{% if edit_mode %}{{ product.fca_cost_per_wu }}{% endif %}">
          </div>
          <div class="aircraft-form-group">
            <label>Currency</label>
            <div style="display: flex; gap: 1.5rem; align-items: center; padding-top: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="currency_option" id="currencyLocal" value="local" checked style="width: 16px; height: 16px;">
                <label for="currencyLocal" style="color: #e0e6ed; font-weight: normal; margin: 0; cursor: pointer; font-size: 0.9rem;">Local</label>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="currency_option" id="currencyUSD" value="USD" style="width: 16px; height: 16px;">
                <label for="currencyUSD" style="color: #e0e6ed; font-weight: normal; margin: 0; cursor: pointer; font-size: 0.9rem;">USD</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <hr class="aircraft-section-separator" />
      
      <!-- Packaging Information Section -->
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Packaging Information</div>
        <div class="aircraft-form-row three-col">
          <div class="aircraft-form-group">
            <label for="id_packaging">Packaging Type</label>
            <input type="text" class="aircraft-form-control" name="packaging" id="id_packaging" required placeholder="e.g., Box, Bag, Container" value="{% if edit_mode %}{{ product.packaging }}{% endif %}">
          </div>
          <div class="aircraft-form-group">
            <label for="id_packaging_weight">Packaging Weight (kg)</label>
            <input type="number" step="0.01" class="aircraft-form-control" name="packaging_weight" id="id_packaging_weight" required placeholder="0.00" value="{% if edit_mode %}{{ product.packaging_weight }}{% endif %}">
          </div>
          <div class="aircraft-form-group">
            <label for="id_packaging_cost">Packaging Cost</label>
            <input type="number" step="0.01" class="aircraft-form-control" name="packaging_cost" id="id_packaging_cost" required placeholder="0.00" value="{% if edit_mode %}{{ product.packaging_cost }}{% endif %}">
          </div>
          <div class="aircraft-form-group">
            <label for="id_units_per_pack">Units per Pack</label>
            <input type="number" class="aircraft-form-control" name="units_per_pack" id="id_units_per_pack" required placeholder="1" value="{% if edit_mode %}{{ product.units_per_pack }}{% endif %}">
          </div>
        </div>
      </div>
      
      <hr class="aircraft-section-separator" />
      
      <!-- Additional Information Section -->
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Additional Information</div>
        <div class="aircraft-form-group">
          <label for="id_other_info">Other Information</label>
          <textarea class="aircraft-form-control" name="other_info" id="id_other_info" rows="4" placeholder="Additional notes or specifications">{% if edit_mode %}{{ product.other_info }}{% endif %}</textarea>
        </div>
      </div>
      
      <input type="hidden" name="currency" id="currencyField">
      
      <button type="submit" class="aircraft-btn">{% if edit_mode %}Save Changes{% else %}Add Product{% endif %}</button>
    </form>
  </div>
</div>
{% endif %}

<script>
console.log('=== Product form script loaded ===');

// Wait for form to be in DOM
setTimeout(function() {
  const form = document.getElementById('product-form');
  if (!form) {
    console.error('Form not found!');
    return;
  }
  
  console.log('Form found, attaching handlers');
  
  const countrySelect = document.getElementById('id_country');
  const localRadio = document.getElementById('currencyLocal');
  const usdRadio = document.getElementById('currencyUSD');
  const currencyField = document.getElementById('currencyField');
  const productTypeSelect = document.getElementById('id_product_type');
  const productCodeInput = document.getElementById('id_product_code');
  
  // Load countries
  function loadCountries() {
    // This should be populated by the backend, but here's a placeholder structure
    // In your actual implementation, you'll pass countries from the view
    console.log('Countries should be loaded from backend');
  }
  
  // Currency management
  function setCurrencyValue() {
    const selectedOption = countrySelect.selectedOptions[0];
    const countryCurrencyCode = selectedOption?.getAttribute('data-currency');
    
    if (usdRadio.checked) {
      currencyField.value = 'USD';
    } else {
      currencyField.value = countryCurrencyCode || '';
    }
  }
  
  // Auto-generate product code based on product type
  function generateProductCode() {
    const type = productTypeSelect.value;
    const timestamp = Date.now().toString().slice(-6);
    let prefix = 'PRD';
    
    switch(type) {
      case 'Produce': prefix = 'PROD'; break;
      case 'Meats': prefix = 'MEAT'; break;
      case 'Other Perishable': prefix = 'PERI'; break;
      case 'Dry Goods': prefix = 'DRY'; break;
      case 'Technology': prefix = 'TECH'; break;
      case 'Other': prefix = 'OTH'; break;
    }
    
    productCodeInput.value = `${prefix}-${timestamp}`;
  }
  
  // Format numeric fields on blur
  function formatNumberInput(input) {
    let val = input.value.replace(/,/g, '');
    if (val && !isNaN(val)) {
      let num = parseFloat(val);
      let rounded = Math.round(num * 100) / 100;
      input.value = rounded.toString();
    }
  }
  
  // Attach event listeners
  if (usdRadio && localRadio && countrySelect) {
    usdRadio.addEventListener('change', setCurrencyValue);
    localRadio.addEventListener('change', setCurrencyValue);
    countrySelect.addEventListener('change', setCurrencyValue);
    setCurrencyValue();
  }
  
  if (productTypeSelect) {
    productTypeSelect.addEventListener('change', generateProductCode);
    // Generate initial code if empty
    if (!productCodeInput.value) {
      generateProductCode();
    }
  }
  
  // Format numeric fields
  const numericFields = [
    'id_fca_cost', 'id_packaging_weight', 'id_packaging_cost', 'id_units_per_pack'
  ];
  numericFields.forEach(function(id) {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('blur', function() {
        formatNumberInput(el);
      });
    }
  });
  
  // Prevent Enter key from submitting unintentionally
  form.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.type !== 'submit') {
      e.preventDefault();
    }
  });
  
  // Form validation and submission
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log('Form submit prevented');
    
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isValid = false;
        field.style.borderColor = '#f44336';
      } else {
        field.style.borderColor = '#193366';
      }
    });
    
    if (!isValid) {
      alert('Please fill in all required fields before submitting.');
      return;
    }
    
    // Submit via AJAX
    const formData = new FormData(form);
    const submitUrl = form.action;
    console.log('Submitting to:', submitUrl);
    
    fetch(submitUrl, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('Response:', data);
      if (data.success) {
        alert(data.message || 'Product saved successfully!');
        // Optionally reload the Export tab or close this tab
        if (window.setActiveTab) {
          window.setActiveTab('Export');
        }
      } else {
        alert('Error: ' + (data.error || 'Failed to save product'));
      }
    })
    .catch(error => {
      console.error('Error saving product:', error);
      alert('An error occurred while saving the product.');
    });
  });
  
  loadCountries();
}, 100);
</script>
