{% load crispy_forms_tags %}
<div class="tab-content-inner mode-tab">
  <h2>Mode Settings</h2>
  <div class="mode-section">
    <h3>Charter</h3>
    <div class="charter-subsection">
      <h4>Available Charter Providers</h4>
      <div class="charter-provider-list">
        <h2 class="aircraft-section-title">Available Charter Providers</h2>
        <table style="width:100%;border-collapse:collapse;background:#23272e;color:#fff;">
          <thead>
            <tr style="background:#26304a;">
              <th style="padding:8px 12px;width:40px;"></th>
              <th style="padding:8px 12px;text-align:left;">Name</th>
              <th style="padding:8px 12px;text-align:left;">Country</th>
              <th style="padding:8px 12px;text-align:left;">Main Base</th>
              <th style="padding:8px 12px;text-align:left;">Aircraft</th>
              <th style="padding:8px 12px;text-align:left;">Block Hour Cost</th>
              <th style="padding:8px 12px;text-align:left;">Type</th>
            </tr>
          </thead>
          <tbody>
            {% for provider in providers %}
            <tr>
              <td style="padding:8px 12px;text-align:center;"><input type="checkbox" class="charter-provider-select-checkbox" value="{{ provider.id }}" /></td>
              <td style="padding:8px 12px;">{{ provider.name }}</td>
              <td style="padding:8px 12px;">{{ provider.country }}</td>
              <td style="padding:8px 12px;">{{ provider.main_base }}</td>
              <td style="padding:8px 12px;">{{ provider.aircraft }}</td>
              <td style="padding:8px 12px;">{{ provider.block_hour_cost }}</td>
              <td style="padding:8px 12px;">{{ provider.get_type_display }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="7" style="padding:8px 12px;text-align:center;"><em>No providers yet.</em></td></tr>
            {% endfor %}
          </tbody>
        </table>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button id="add-charter-provider-btn" class="primary-button" type="button" onclick="toggleCharterProviderForm()">Add Charter Provider</button>
          <button id="edit-charter-provider-btn" class="primary-button" type="button" disabled>Edit Selected</button>
          <button id="delete-charter-provider-btn" class="danger-button" type="button" disabled>Delete Selected</button>
        </div>
      </div>
    </div>
    <div class="charter-subsection">
      <form id="charter-provider-form" method="post" style="display:none; margin-top:16px;">
        {% csrf_token %}
        <input type="hidden" id="provider-id" name="provider_id" value="">
        <div class="aircraft-form-section">
          <div class="aircraft-section-title" id="charter-form-title">Add Charter Provider</div>
          <div class="aircraft-form-row three-col unified-spacing">
            {{ form.name|as_crispy_field }}
            {{ form.country|as_crispy_field }}
            {{ form.main_base|as_crispy_field }}
            {{ form.aircraft|as_crispy_field }}
            {{ form.block_hour_cost|as_crispy_field }}
            {{ form.type|as_crispy_field }}
          </div>
        </div>
        <button type="submit" class="aircraft-btn" id="save-provider-btn">Save Provider</button>
      </form>
    </div>
  </div>
</div>
<script>
function toggleCharterProviderForm(isEdit) {
  var form = document.getElementById('charter-provider-form');
  var title = document.getElementById('charter-form-title');
  var providerIdField = document.getElementById('provider-id');
  
  if (form.style.display === 'none' || isEdit) {
    form.style.display = 'block';
    
    if (!isEdit) {
      // Reset form for add mode
      form.reset();
      if (title) title.textContent = 'Add Charter Provider';
      if (providerIdField) providerIdField.value = '';
    }
    
    setTimeout(function() {
      var mainBaseSelect = document.getElementById('id_main_base');
      if (mainBaseSelect && !mainBaseSelect.dataset.listenerAdded) {
        mainBaseSelect.dataset.listenerAdded = 'true';
        mainBaseSelect.addEventListener('change', function() {
          if (mainBaseSelect.value === 'add') {
            window.dispatchEvent(new CustomEvent('openTab', { detail: { tab: 'add_airport' } }));
            mainBaseSelect.value = '';
          }
        });
      }
    }, 100);
  } else {
    form.style.display = 'none';
  }
}
window.toggleCharterProviderForm = toggleCharterProviderForm;

function initializeModeTabHandlers() {
  // Filter main base dropdown by selected country
  var countrySelect = document.getElementById('id_country');
  var mainBaseSelect = document.getElementById('id_main_base');
  if (countrySelect && mainBaseSelect) {
    if (countrySelect._countryChangeHandler) {
      countrySelect.removeEventListener('change', countrySelect._countryChangeHandler);
    }
    countrySelect._countryChangeHandler = function() {
      var countryId = countrySelect.value;
      if (!countryId) return;
      fetch('/api/airports-by-country/?country_id=' + countryId)
        .then(response => response.json())
        .then(data => {
          while (mainBaseSelect.options.length > 0) mainBaseSelect.remove(0);
          if (Array.isArray(data.airports) && data.airports.length > 0) {
            data.airports.forEach(function(airport) {
              if (airport && airport.id && airport.iata_code) {
                var opt = document.createElement('option');
                opt.value = airport.id;
                opt.textContent = airport.iata_code;
                if (mainBaseSelect && typeof mainBaseSelect.appendChild === 'function') {
                  mainBaseSelect.appendChild(opt);
                } else {
                  console.error('mainBaseSelect is not a valid Node:', mainBaseSelect, 'airports:', data.airports);
                }
              }
            });
          } else {
            if (!Array.isArray(data.airports)) {
              console.error('data.airports is not an array:', data.airports);
            }
          }
          var addOpt = document.createElement('option');
          addOpt.value = 'add';
          addOpt.textContent = 'Add Base';
          mainBaseSelect.appendChild(addOpt);
        })
        .catch(err => console.error('Error fetching airports:', err));
    };
    countrySelect.addEventListener('change', countrySelect._countryChangeHandler);
  }

  // Charter Provider single-selection logic, delete button, and AJAX submit
  const checkboxes = document.querySelectorAll('.charter-provider-select-checkbox');
  const editBtn = document.getElementById('edit-charter-provider-btn');
  const deleteBtn = document.getElementById('delete-charter-provider-btn');
  const providerForm = document.getElementById('charter-provider-form');

  function updateEditBtn() {
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
    if (editBtn) editBtn.disabled = !anyChecked;
    if (deleteBtn) deleteBtn.disabled = !anyChecked;
  }

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        checkboxes.forEach(cb => {
          if (cb !== this) cb.checked = false;
        });
      }
      updateEditBtn();
    });
  });
  updateEditBtn();

  if (editBtn) {
    if (editBtn._editHandler) editBtn.removeEventListener('click', editBtn._editHandler);
    editBtn._editHandler = function() {
      const selected = Array.from(checkboxes).find(cb => cb.checked);
      if (selected) {
        const providerId = selected.value;
        
        // Fetch provider data
        fetch('/edit-charter-provider/' + providerId + '/', {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.success) {
            // Populate form with provider data
            const form = document.getElementById('charter-provider-form');
            const title = document.getElementById('charter-form-title');
            const providerIdField = document.getElementById('provider-id');
            
            if (title) title.textContent = 'Edit Charter Provider';
            if (providerIdField) providerIdField.value = providerId;
            
            // Populate form fields
            if (data.data.name) document.getElementById('id_name').value = data.data.name;
            if (data.data.country) document.getElementById('id_country').value = data.data.country;
            if (data.data.block_hour_cost) document.getElementById('id_block_hour_cost').value = data.data.block_hour_cost;
            if (data.data.type) document.getElementById('id_type').value = data.data.type;
            
            // Trigger country change to populate airports, then set main_base
            if (data.data.country) {
              const countrySelect = document.getElementById('id_country');
              const mainBaseSelect = document.getElementById('id_main_base');
              
              if (countrySelect && countrySelect._countryChangeHandler) {
                countrySelect._countryChangeHandler();
                
                // Wait for airports to load, then set values
                setTimeout(function() {
                  if (data.data.main_base) mainBaseSelect.value = data.data.main_base;
                  if (data.data.aircraft) document.getElementById('id_aircraft').value = data.data.aircraft;
                }, 500);
              }
            }
            
            // Show the form
            toggleCharterProviderForm(true);
          } else {
            alert('Error loading provider: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Error loading provider data.');
        });
      }
    };
    editBtn.addEventListener('click', editBtn._editHandler);
  }

  // Delete behavior is handled globally in home.html to avoid duplicate bindings

  if (providerForm) {
    if (providerForm._submitHandler) providerForm.removeEventListener('submit', providerForm._submitHandler);
    providerForm._submitHandler = function(e) {
      e.preventDefault();
      // Disable button to prevent double-clicks
      var submitBtn = document.getElementById('save-provider-btn');
      if (submitBtn) submitBtn.disabled = true;
      // Show progress modal
      if (window.showProgressModal) {
        window.showProgressModal('Provider saved successfully!', 'Please wait while the system updates routes...');
      }
      
      var formData = new FormData(providerForm);
      var providerId = document.getElementById('provider-id').value;
      var url = providerId ? '/edit-charter-provider/' + providerId + '/' : '/mode-tab/';
      
      fetch(url, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      })
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (window.hideProgressModal) window.hideProgressModal();
        if (submitBtn) submitBtn.disabled = false;
        if (data.success) {
          fetch('/mode-tab/')
            .then(function(response) { return response.text(); })
            .then(function(html) {
              var parser = new DOMParser();
              var doc = parser.parseFromString(html, 'text/html');
              var content = doc.querySelector('.tab-content-inner.mode-tab');
              if (content) {
                var tabContent = document.getElementById('tab-content');
                if (tabContent) {
                  tabContent.innerHTML = content.outerHTML;
                  if (window.initializeModeTabHandlers) {
                    setTimeout(window.initializeModeTabHandlers, 100);
                  }
                }
              }
            });
        } else {
          alert('Error saving provider: ' + JSON.stringify(data.errors || 'Unknown error'));
        }
      })
      .catch(function(err) { 
        if (window.hideProgressModal) window.hideProgressModal();
        if (submitBtn) submitBtn.disabled = false;
        console.error('Error:', err);
        alert('Error saving provider.');
      });
    };
    providerForm.addEventListener('submit', providerForm._submitHandler);
  }
}

window.initializeModeTabHandlers = initializeModeTabHandlers;

// Initialize immediately if document is already ready (AJAX case), otherwise wait for DOMContentLoaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeModeTabHandlers);
} else {
  initializeModeTabHandlers();
}
</script>
