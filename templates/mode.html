{% load crispy_forms_tags %}
<div class="tab-content-inner mode-tab">
  <h2>Mode Settings</h2>
  <div class="mode-section">
    <h3>Charter</h3>
    <div class="charter-subsection">
      <h4>Available Charter Providers</h4>
      <div class="charter-provider-list">
        <h2 class="aircraft-section-title">Available Charter Providers</h2>
        <table style="width:100%;border-collapse:collapse;background:#23272e;color:#fff;">
          <thead>
            <tr style="background:#26304a;">
              <th style="padding:8px 12px;width:40px;"></th>
              <th style="padding:8px 12px;text-align:left;">Name</th>
              <th style="padding:8px 12px;text-align:left;">Country</th>
              <th style="padding:8px 12px;text-align:left;">Main Base</th>
              <th style="padding:8px 12px;text-align:left;">Aircraft</th>
              <th style="padding:8px 12px;text-align:left;">Block Hour Cost</th>
            </tr>
          </thead>
          <tbody>
            {% for provider in providers %}
            <tr>
              <td style="padding:8px 12px;text-align:center;"><input type="checkbox" class="charter-provider-select-checkbox" value="{{ provider.id }}" /></td>
              <td style="padding:8px 12px;">{{ provider.name }}</td>
              <td style="padding:8px 12px;">{{ provider.country }}</td>
              <td style="padding:8px 12px;">{{ provider.main_base }}</td>
              <td style="padding:8px 12px;">{{ provider.aircraft }}</td>
              <td style="padding:8px 12px;">{{ provider.block_hour_cost }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6" style="padding:8px 12px;text-align:center;"><em>No providers yet.</em></td></tr>
            {% endfor %}
          </tbody>
        </table>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button id="add-charter-provider-btn" class="primary-button" type="button" onclick="toggleCharterProviderForm()">Add Charter Provider</button>
          <button id="edit-charter-provider-btn" class="primary-button" disabled>Edit Selected</button>
          <button id="delete-charter-provider-btn" class="danger-button" disabled>Delete Selected</button>
        </div>
      </div>
    </div>
    <div class="charter-subsection">
      <form id="charter-provider-form" method="post" style="display:none; margin-top:16px;">
        {% csrf_token %}
        <div class="aircraft-form-section">
          <div class="aircraft-section-title">Add Charter Provider</div>
          <div class="aircraft-form-row three-col unified-spacing">
            {{ form.name|as_crispy_field }}
            {{ form.country|as_crispy_field }}
            {{ form.main_base|as_crispy_field }}
            {{ form.aircraft|as_crispy_field }}
            {{ form.block_hour_cost|as_crispy_field }}
          </div>
        </div>
        <button type="submit" class="aircraft-btn" id="save-provider-btn">Save Provider</button>
      </form>
    </div>
  </div>
</div>
<script>
// Charter Provider single-selection logic and Edit Selected button
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.charter-provider-select-checkbox');
  const editBtn = document.getElementById('edit-charter-provider-btn');
  const deleteBtn = document.getElementById('delete-charter-provider-btn');
  function updateEditBtn() {
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
    if (editBtn) editBtn.disabled = !anyChecked;
    if (deleteBtn) deleteBtn.disabled = !anyChecked;
  }
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        checkboxes.forEach(cb => {
          if (cb !== this) cb.checked = false;
        });
      }
      updateEditBtn();
    });
  });
  updateEditBtn();
  if (editBtn) {
    editBtn.addEventListener('click', function() {
      const selected = Array.from(checkboxes).find(cb => cb.checked);
      if (selected) {
        // TODO: Open edit provider form (implement as needed)
        alert('Edit provider ID: ' + selected.value);
      }
    });
  }

  if (deleteBtn) {
    deleteBtn.addEventListener('click', function() {
      const selected = Array.from(checkboxes).find(cb => cb.checked);
      if (selected) {
        if (confirm('Are you sure you want to delete this Charter Provider? This action cannot be undone.')) {
          fetch(`/delete-charter-provider/${selected.value}/`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error deleting provider: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(() => alert('Error deleting provider.'));
        }
      }
    });
  }
});

function toggleCharterProviderForm() {
  var form = document.getElementById('charter-provider-form');
  if (form.style.display === 'none') {
    form.style.display = 'block';
    setTimeout(function() {
      var mainBaseSelect = document.getElementById('id_main_base');
      if (mainBaseSelect && !mainBaseSelect.dataset.listenerAdded) {
        mainBaseSelect.dataset.listenerAdded = 'true';
        mainBaseSelect.addEventListener('change', function() {
          if (mainBaseSelect.value === 'add') {
            window.dispatchEvent(new CustomEvent('openTab', { detail: { tab: 'add_airport' } }));
            mainBaseSelect.value = '';
          }
        });
      }
    }, 100);
  } else {
    form.style.display = 'none';
  }
}
window.toggleCharterProviderForm = toggleCharterProviderForm;

// AJAX submit for Charter Provider form
var providerForm = document.getElementById('charter-provider-form');
if (providerForm && !providerForm.dataset.handlerAttached) {
  providerForm.dataset.handlerAttached = 'true';
  providerForm.addEventListener('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(providerForm);
    fetch('/mode-tab/', {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
      if (data.success) {
        fetch('/mode-tab/')
          .then(function(response) { return response.text(); })
          .then(function(html) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var content = doc.querySelector('.tab-content-inner.mode-tab');
            if (content) {
              var tabContent = document.getElementById('tab-content');
              if (tabContent) {
                tabContent.innerHTML = content.outerHTML;
              }
            }
          });
      } else {
        alert('Error saving provider: ' + JSON.stringify(data.errors || 'Unknown error'));
      }
    })
    .catch(function(err) { 
      console.error('Error:', err);
      alert('Error saving provider.');
    });
  });
}
</script>
