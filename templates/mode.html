{% load crispy_forms_tags %}
<div class="tab-content-inner mode-tab">
  <h2>Mode Settings</h2>
  <div class="mode-section">
    <h3>Charter</h3>
    <div class="charter-subsection">
      <h4>Available Charter Providers</h4>
      <div class="charter-provider-list">
        {% if providers %}
          <ul>
            {% for provider in providers %}
              <li>{{ provider.name }} ({{ provider.country }}) - Main base: {{ provider.main_base }} | Block hour cost: {{ provider.block_hour_cost }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p><em>No providers yet.</em></p>
        {% endif %}
      </div>
    </div>
    <div class="charter-subsection">
      <button type="button" class="aircraft-btn" onclick="toggleCharterProviderForm()">Add Charter Provider</button>
      <form id="charter-provider-form" method="post" style="display:none; margin-top:16px;">
        {% csrf_token %}
        <div class="aircraft-form-section">
          <div class="aircraft-section-title">Add Charter Provider</div>
          <div class="aircraft-form-row three-col unified-spacing">
            {{ form.name|as_crispy_field }}
            {{ form.country|as_crispy_field }}
            {{ form.main_base|as_crispy_field }}
            {{ form.aircraft|as_crispy_field }}
            {{ form.block_hour_cost|as_crispy_field }}
          </div>
        </div>
        <button type="submit" class="aircraft-btn" id="save-provider-btn">Save Provider</button>
      </form>
    </div>
  </div>
</div>
<script>
(function() {
function toggleCharterProviderForm() {
  var form = document.getElementById('charter-provider-form');
  if (form.style.display === 'none') {
    form.style.display = 'block';
    // Set up the event listener when form is shown
    setTimeout(function() {
      var mainBaseSelect = document.getElementById('id_main_base');
      if (mainBaseSelect && !mainBaseSelect.dataset.listenerAdded) {
        mainBaseSelect.dataset.listenerAdded = 'true';
        mainBaseSelect.addEventListener('change', function() {
          if (mainBaseSelect.value === 'add') {
            // Open the add_airport form in a new tab
            window.dispatchEvent(new CustomEvent('openTab', { detail: { tab: 'add_airport' } }));
            // Reset selection
            mainBaseSelect.value = '';
          }
        });
      }
    }, 100);
  } else {
    form.style.display = 'none';
  }
}
// Make toggleCharterProviderForm global
window.toggleCharterProviderForm = toggleCharterProviderForm;

// AJAX submit for Charter Provider form - runs immediately when script loads
var providerForm = document.getElementById('charter-provider-form');
if (providerForm && !providerForm.dataset.handlerAttached) {
  providerForm.dataset.handlerAttached = 'true';
  providerForm.addEventListener('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(providerForm);
    fetch('/mode-tab/', {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
      if (data.success) {
        // Reload just the mode tab content via AJAX
        fetch('/mode-tab/')
          .then(function(response) { return response.text(); })
          .then(function(html) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var content = doc.querySelector('.tab-content-inner.mode-tab');
            if (content) {
              var tabContent = document.getElementById('tab-content');
              if (tabContent) {
                tabContent.innerHTML = content.outerHTML;
              }
            }
          });
      } else {
        alert('Error saving provider: ' + JSON.stringify(data.errors || 'Unknown error'));
      }
    })
    .catch(function(err) { 
      console.error('Error:', err);
      alert('Error saving provider.');
    });
  });
}
})();
</script>
