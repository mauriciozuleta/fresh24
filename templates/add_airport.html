{% load crispy_forms_tags %}
{% if form %}
<div class="tab-content-inner aircraft-form-page">
  <div class="aircraft-header">
    <h1 class="aircraft-title">Add New Airport</h1>
  </div>
  <div class="aircraft-form-container">
    <style>
      .fixed-scroll-form {
        max-width: 900px;
        min-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 0 auto;
        background: #181c22;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }
      .unified-spacing {
        gap: 2rem !important;
        margin-bottom: 2rem !important;
      }
      .aircraft-form-section {
        margin-bottom: 2rem !important;
      }
      .aircraft-section-title {
        margin-bottom: 1rem !important;
      }
    </style>
    <form method="post" action="{% if edit_mode %}/edit-airport/{{ airport_id }}/{% else %}/add-airport/{% endif %}" id="airport-form" class="fixed-scroll-form">
      {% csrf_token %}
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Basic Information</div>
        <div class="aircraft-form-row three-col unified-spacing">
          <div class="aircraft-form-group">{{ form.iata_code|as_crispy_field|safe }}</div>
          <div class="aircraft-form-group">{{ form.name|as_crispy_field|safe }}</div>
          <div class="aircraft-form-group">{{ form.city|as_crispy_field|safe }}</div>
          <div class="aircraft-form-group">{{ form.country|as_crispy_field|safe }}</div>
        </div>
      </div>
      <hr class="aircraft-section-separator" />
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Cost Information</div>
        <div class="aircraft-form-row three-col unified-spacing">
          <div class="aircraft-form-group">{{ form.fuel_cost_gl|as_crispy_field }}</div>
          <div class="aircraft-form-group">{{ form.cargo_handling_cost_kg|as_crispy_field }}</div>
          <div class="aircraft-form-group">{{ form.airport_fee|as_crispy_field }}</div>
          <div class="aircraft-form-group">{{ form.turnaround_cost|as_crispy_field }}</div>
        </div>
      </div>
      <hr class="aircraft-section-separator" />
      <div class="aircraft-form-section">
        <div class="aircraft-section-title">Additional & Location Information</div>
        <div class="aircraft-form-row three-col unified-spacing">
          <div class="aircraft-form-group">{{ form.other_desc|as_crispy_field }}</div>
          <div class="aircraft-form-group">{{ form.other_cost|as_crispy_field }}</div>
          <div class="aircraft-form-group">{{ form.altitude_ft|as_crispy_field }}</div>
        </div>
      </div>
      <input type="hidden" id="id_latitude" name="latitude">
      <input type="hidden" id="id_longitude" name="longitude">
      <button type="submit" class="aircraft-btn">{% if edit_mode %}Save Changes{% else %}Add Airport{% endif %}</button>
    </form>
  </div>
</div>
{% endif %}

<script>
console.log('=== Airport form script loaded ===');
// Airport form logic
(function() {
  const iataInput = document.getElementById('id_iata_code');
  const nameInput = document.getElementById('id_name');
  const cityInput = document.getElementById('id_city');
  const countryInput = document.getElementById('id_country');
  const latInput = document.getElementById('id_latitude');
  const lonInput = document.getElementById('id_longitude');
  const altInput = document.getElementById('id_altitude_ft');
  const form = document.getElementById('airport-form');

  // Format numeric fields on blur
  function formatNumberInput(input) {
    let val = input.value.replace(/,/g, '');
    if (val && !isNaN(val)) {
      let parts = val.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      input.value = parts.join('.');
    }
  }
  const numericFields = [
    'id_fuel_cost_gl', 'id_cargo_handling_cost_kg', 'id_airport_fee', 'id_turnaround_cost',
    'id_other_cost', 'id_altitude_ft', 'id_latitude', 'id_longitude'
  ];
  numericFields.forEach(function(id) {
    const el = document.getElementById(id);
    if (el) {
      // Ensure cost fields are never readonly/disabled
      if (id === 'id_fuel_cost_gl' || id === 'id_cargo_handling_cost_kg' || 
          id === 'id_airport_fee' || id === 'id_turnaround_cost' || id === 'id_other_cost') {
        el.readOnly = false;
        el.disabled = false;
      }
      el.addEventListener('blur', function() { formatNumberInput(el); });
    }
  });

  if (iataInput) {
    iataInput.addEventListener('input', function() {
      this.value = this.value.toUpperCase();
      if (this.value.length === 3) {
        if (nameInput) { nameInput.value = 'Searching...'; nameInput.readOnly = true; }
        if (cityInput) { cityInput.value = 'Searching...'; cityInput.readOnly = true; }
        if (countryInput) { countryInput.value = ''; countryInput.readOnly = true; }
        fetch('/api/airport-lookup/?iata_code=' + encodeURIComponent(this.value))
          .then(function(response) { if (!response.ok) throw new Error('Airport not found'); return response.json(); })
          .then(function(data) {
            if (nameInput) nameInput.value = data.name || '';
            if (cityInput) cityInput.value = data.city || '';
            if (countryInput) countryInput.value = data.country || '';
            if (latInput) latInput.value = data.latitude || '';
            if (lonInput) lonInput.value = data.longitude || '';
            if (altInput) altInput.value = data.altitude_ft || '';
          })
          .catch(function() {
            if (nameInput) nameInput.value = 'Not Found';
            if (cityInput) cityInput.value = 'Not Found';
            if (countryInput) countryInput.value = '';
            if (latInput) latInput.value = '';
            if (lonInput) lonInput.value = '';
            if (altInput) altInput.value = '';
          });
      }
    });
  }

  // AJAX form submit
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (nameInput) nameInput.readOnly = false;
      if (cityInput) cityInput.readOnly = false;
      if (countryInput) countryInput.readOnly = false;
      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      })
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (data.success) {
          // Close the tab using VS Code tab logic
          if (window.closeCurrentTab) {
            window.closeCurrentTab();
          } else {
            // Fallback: reload page
            window.location.reload();
          }
        }
      })
      .catch(function() {
        alert('Error saving airport.');
      });
    });
  }
})();
</script>
